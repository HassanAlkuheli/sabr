name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_PROJECT_NAME: sabr

jobs:
  # ============================================
  # STEP 1: Build Production Images
  # ============================================
  build:
    name: Build Production Images
    runs-on: self-hosted

    steps:
      - name: Clean workspace
        run: |
          rm -rf $GITHUB_WORKSPACE/* || sudo rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build --no-cache \
            --tag sabr-backend:latest \
            -f backend/Dockerfile \
            backend/

      - name: Build frontend image
        run: |
          docker build --no-cache \
            --build-arg API_URL=https://api.sabr.haskify.com \
            --tag sabr-frontend:latest \
            -f frontend/Dockerfile \
            frontend/

  # ============================================
  # STEP 2: Deploy
  # ============================================
  deploy:
    name: Deploy Services
    runs-on: self-hosted
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file with full configuration
        env:
          # Required Secrets (NO fallbacks ‚Äî must be set in GitHub Secrets)
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          SEED_PASSWORD: ${{ secrets.SEED_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SMTP_EMAIL: ${{ secrets.SMTP_EMAIL }}
          SMTP_APP_PASSWORD: ${{ secrets.SMTP_APP_PASSWORD }}
          
          # Configurable values (safe defaults)
          ACME_EMAIL: ${{ secrets.ACME_EMAIL || 'admin@sabr.haskify.com' }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'sabr' }}
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER || 'admin' }}
          PGADMIN_DEFAULT_EMAIL: ${{ secrets.PGADMIN_DEFAULT_EMAIL || 'admin@sabr.haskify.com' }}
          PGADMIN_DEFAULT_PASSWORD: ${{ secrets.PGADMIN_DEFAULT_PASSWORD || 'admin' }}
          
          # Fixed / defaults
          PORT: 3000
          DEPLOY_DOMAIN: sabr.haskify.com
          MINIO_ENDPOINT: localhost
          MINIO_PORT: 9002
          MINIO_BUCKET: sabr
          MINIO_USE_SSL: false
          FRONTEND_URL: https://sabr.haskify.com
        run: |
          echo "üìù Writing complete .env file..."
          
          cat <<EOF > .env
          # Auto-generated by CI/CD
          PORT=$PORT
          JWT_SECRET=$JWT_SECRET
          DEPLOY_DOMAIN=$DEPLOY_DOMAIN
          CORS_ORIGIN=https://$DEPLOY_DOMAIN
          
          # Let's Encrypt
          ACME_EMAIL=$ACME_EMAIL
          
          # Database
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_USER=$POSTGRES_USER
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          POSTGRES_DB=$POSTGRES_DB
          # Note: DATABASE_URL is constructed automatically by backend/src/config/env.ts using these vars
          # to ensure proper URL encoding of special characters in passwords.

          
          # MinIO
          MINIO_ENDPOINT=$MINIO_ENDPOINT
          MINIO_PORT=$MINIO_PORT
          MINIO_ROOT_USER=$MINIO_ROOT_USER
          MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
          MINIO_ACCESS_KEY=$MINIO_ROOT_USER
          MINIO_SECRET_KEY=$MINIO_ROOT_PASSWORD
          MINIO_USE_SSL=$MINIO_USE_SSL
          MINIO_BUCKET=$MINIO_BUCKET
          
          # pgAdmin
          PGADMIN_DEFAULT_EMAIL=$PGADMIN_DEFAULT_EMAIL
          PGADMIN_DEFAULT_PASSWORD=$PGADMIN_DEFAULT_PASSWORD
          
          # App Config
          RUNNER_TIMEOUT_MINUTES=30
          VIEWER_TIMEOUT_MINUTES=30
          MAX_UPLOAD_SIZE_MB=50
          
          # AI (LangChain / OpenAI)
          OPENAI_API_KEY=$OPENAI_API_KEY
          
          # Email (Password Reset)
          SMTP_EMAIL=$SMTP_EMAIL
          SMTP_APP_PASSWORD=$SMTP_APP_PASSWORD
          FRONTEND_URL=$FRONTEND_URL
          
          # Seeding
          ADMIN_PASSWORD=$ADMIN_PASSWORD
          SEED_PASSWORD=$SEED_PASSWORD
          EOF
          
          echo "‚úÖ .env file created successfully"

      - name: Deploy with Docker Compose
        run: |
          echo "üöÄ Deploying with Docker Compose..."
          # Load .env to ensure shell has variables (redundant with .env file but safe)
          set -o allexport
          source .env
          set +o allexport
          
          docker compose -f docker-compose.prod.yml up -d --force-recreate
          echo "Waiting for services to be healthy..."
          sleep 20

  # ============================================
  # STEP 3: Health Check
  # ============================================
  health-check:
    name: Health Check
    runs-on: self-hosted
    needs: deploy

    steps:
      - name: Check backend health
        run: |
          echo "Checking backend health..."
          for i in {1..30}; do
            if docker exec sabr-backend wget --no-verbose --tries=1 --spider http://localhost:3000/ 2>/dev/null; then
              echo "‚úÖ Backend is healthy!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Backend health check failed"
              docker logs sabr-backend --tail 50
              exit 1
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: Check frontend health
        run: |
          echo "Checking frontend health..."
          for i in {1..15}; do
            if docker exec sabr-frontend curl -f -s http://localhost/ > /dev/null; then
              echo "‚úÖ Frontend is healthy!"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "‚ùå Frontend health check failed"
              # Run verbose curl to see why it failed
              echo "Debug: Curl output:"
              docker exec sabr-frontend curl -v http://localhost/ || true
              docker logs sabr-frontend --tail 50
              exit 1
            fi
            echo "Waiting for frontend... ($i/15)"
            sleep 2
          done

  # ============================================
  # STEP 4: Database Migrations & Seeding
  # ============================================
  migrate-and-seed:
    name: Migrate & Seed
    runs-on: self-hosted
    needs: health-check

    steps:
      - name: Run database migrations
        run: |
          echo "üóÉÔ∏è Running database migrations..."
          docker exec sabr-backend bunx drizzle-kit migrate

      - name: Seed admin account
        env:
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          echo "üë§ Seeding admin account..."
          docker exec -e ADMIN_PASSWORD="$ADMIN_PASSWORD" sabr-backend bun run src/scripts/seed-admin.ts || echo "Admin may already exist"

      - name: Seed production data
        env:
          SEED_PASSWORD: ${{ secrets.SEED_PASSWORD }}
        run: |
          echo "üå± Seeding production data (professor, student, labs, projects)..."
          docker exec -e SEED_PASSWORD="$SEED_PASSWORD" sabr-backend bun run src/scripts/seed-production.ts || echo "Production data may already exist"

  # ============================================
  # STEP 5: Cleanup & Summary
  # ============================================
  summary:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [build, deploy, health-check, migrate-and-seed]
    if: success()

    steps:
      - name: Cleanup old images
        run: |
          docker image prune -f

      - name: Deployment Summary
        run: |
          echo "============================================"
          echo "       SABR DEPLOYMENT COMPLETE"
          echo "============================================"
          echo ""
          echo "üåê Public Access:"
          echo "   Frontend: https://sabr.haskify.com"
          echo "   API:      https://api.sabr.haskify.com"
          echo ""
          echo "üì¶ Running Containers:"
          docker ps --filter "name=sabr" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "üîé TRAEFIK DEBUG LOGS (Last 50 lines):"
          docker logs traefik --tail 50
          echo "============================================"

  # ============================================
  # Rollback on Failure
  # ============================================
  rollback:
    name: Rollback on Failure
    runs-on: self-hosted
    needs: [deploy, health-check, migrate-and-seed]
    if: failure()

    steps:
      - name: Show failure logs
        run: |
          echo "‚ùå Deployment failed! Showing logs..."
          echo ""
          echo "=== Backend Logs ==="
          docker logs sabr-backend --tail 30 2>&1 || true
          echo ""
          echo "=== Frontend Logs ==="
          docker logs sabr-frontend --tail 30 2>&1 || true
          echo ""
          echo "=== Traefik Logs ==="
          docker logs traefik --tail 30 2>&1 || true
          echo ""
          echo "‚ö†Ô∏è Manual investigation required."
