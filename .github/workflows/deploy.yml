name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_PROJECT_NAME: sabr

jobs:
  # ============================================
  # STEP 1: Build Production Images
  # ============================================
  build:
    name: Build Production Images
    runs-on: self-hosted

    steps:
      - name: Clean workspace
        run: |
          rm -rf $GITHUB_WORKSPACE/* || sudo rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build \
            --tag sabr-backend:latest \
            -f backend/Dockerfile \
            backend/

      - name: Build frontend image
        run: |
          docker build \
            --build-arg API_URL=https://api.sabr.haskify.com \
            --tag sabr-frontend:latest \
            -f frontend/Dockerfile \
            frontend/

  # ============================================
  # STEP 2: Deploy
  # ============================================
  deploy:
    name: Deploy Services
    runs-on: self-hosted
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write .env file
        env:
          PRODUCTION_ENV: ${{ secrets.PRODUCTION_ENV }}
        run: |
          echo "üìù Writing .env..."
          printf '%s\n' "$PRODUCTION_ENV" > .env

      - name: Deploy with Docker Compose
        env:
          # Fallback if ACME_EMAIL is missing from .env (can be set as separate secret)
          ACME_EMAIL: ${{ secrets.ACME_EMAIL || 'admin@sabr.haskify.com' }}
        run: |
          echo "üöÄ Deploying with Docker Compose..."
          # Export ACME_EMAIL explicitly if not in .env
          if ! grep -q "ACME_EMAIL=" .env; then
            echo "‚ö†Ô∏è ACME_EMAIL missing from .env, using default/secret value"
            export ACME_EMAIL
          fi
          docker compose -f docker-compose.prod.yml up -d --force-recreate
          echo "Waiting for services to be healthy..."
          sleep 20

  # ============================================
  # STEP 3: Health Check
  # ============================================
  health-check:
    name: Health Check
    runs-on: self-hosted
    needs: deploy

    steps:
      - name: Check backend health
        run: |
          echo "Checking backend health..."
          for i in {1..30}; do
            if docker exec sabr-backend wget --no-verbose --tries=1 --spider http://localhost:3000/ 2>/dev/null; then
              echo "‚úÖ Backend is healthy!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Backend health check failed"
              docker logs sabr-backend --tail 50
              exit 1
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: Check frontend health
        run: |
          echo "Checking frontend health..."
          for i in {1..15}; do
            if docker exec sabr-frontend wget --no-verbose --tries=1 --spider http://localhost:80/ 2>/dev/null; then
              echo "‚úÖ Frontend is healthy!"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "‚ùå Frontend health check failed"
              docker logs sabr-frontend --tail 50
              exit 1
            fi
            echo "Waiting for frontend... ($i/15)"
            sleep 2
          done

  # ============================================
  # STEP 4: Database Migrations & Seeding
  # ============================================
  migrate-and-seed:
    name: Migrate & Seed
    runs-on: self-hosted
    needs: health-check

    steps:
      - name: Run database migrations
        run: |
          echo "üóÉÔ∏è Running database migrations..."
          docker exec sabr-backend bunx drizzle-kit migrate || echo "Migration may have already been applied"

      - name: Seed admin account
        env:
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          echo "üë§ Seeding admin account..."
          docker exec -e ADMIN_PASSWORD="$ADMIN_PASSWORD" sabr-backend bun run src/scripts/seed-admin.ts || echo "Admin may already exist"

      - name: Seed production data
        env:
          SEED_PASSWORD: ${{ secrets.SEED_PASSWORD }}
        run: |
          echo "üå± Seeding production data (professor, student, labs, projects)..."
          docker exec -e SEED_PASSWORD="$SEED_PASSWORD" sabr-backend bun run src/scripts/seed-production.ts || echo "Production data may already exist"

  # ============================================
  # STEP 5: Cleanup & Summary
  # ============================================
  summary:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [build, deploy, health-check, migrate-and-seed]
    if: success()

    steps:
      - name: Cleanup old images
        run: |
          docker image prune -f

      - name: Deployment Summary
        run: |
          echo "============================================"
          echo "       SABR DEPLOYMENT COMPLETE"
          echo "============================================"
          echo ""
          echo "üåê Public Access:"
          echo "   Frontend: https://sabr.haskify.com"
          echo "   API:      https://api.sabr.haskify.com"
          echo ""
          echo "üì¶ Running Containers:"
          docker ps --filter "name=sabr" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "============================================"

  # ============================================
  # Rollback on Failure
  # ============================================
  rollback:
    name: Rollback on Failure
    runs-on: self-hosted
    needs: [deploy, health-check, migrate-and-seed]
    if: failure()

    steps:
      - name: Show failure logs
        run: |
          echo "‚ùå Deployment failed! Showing logs..."
          echo ""
          echo "=== Backend Logs ==="
          docker logs sabr-backend --tail 30 2>&1 || true
          echo ""
          echo "=== Frontend Logs ==="
          docker logs sabr-frontend --tail 30 2>&1 || true
          echo ""
          echo "=== Traefik Logs ==="
          docker logs traefik --tail 30 2>&1 || true
          echo ""
          echo "‚ö†Ô∏è Manual investigation required."
