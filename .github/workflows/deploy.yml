name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_PROJECT_NAME: sabr

jobs:
  # ============================================
  # STEP 1: Build Production Images
  # ============================================
  build:
    name: Build Production Images
    runs-on: self-hosted

    steps:
      - name: Clean workspace
        run: |
          rm -rf $GITHUB_WORKSPACE/* || sudo rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build \
            --tag sabr-backend:latest \
            -f backend/Dockerfile \
            backend/

      - name: Build frontend image
        run: |
          docker build \
            --build-arg API_URL=https://api.sabr.haskify.com \
            --tag sabr-frontend:latest \
            -f frontend/Dockerfile \
            frontend/

  # ============================================
  # STEP 2: Deploy
  # ============================================
  deploy:
    name: Deploy Services
    runs-on: self-hosted
    needs: build
    # Inject all secrets as environment variables so they are available
    # even if missing from the PRODUCTION_ENV file
    env:
      # Secrets that must be set in GitHub
      PRODUCTION_ENV: ${{ secrets.PRODUCTION_ENV }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
      PGADMIN_DEFAULT_PASSWORD: ${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
      
      # Secrets with safe defaults (can be overridden by GitHub Secrets)
      ACME_EMAIL: ${{ secrets.ACME_EMAIL || 'admin@sabr.haskify.com' }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'sabr' }}
      MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER || 'admin' }}
      PGADMIN_DEFAULT_EMAIL: ${{ secrets.PGADMIN_DEFAULT_EMAIL || 'admin@sabr.haskify.com' }}
      
      # App defaults
      PORT: 3000
      DEPLOY_DOMAIN: sabr.haskify.com
      MINIO_ENDPOINT: localhost
      MINIO_PORT: 9002
      RUNNER_TIMEOUT_MINUTES: 30
      VIEWER_TIMEOUT_MINUTES: 30
      MAX_UPLOAD_SIZE_MB: 50

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write .env file
        run: |
          echo "üìù Helper: Preparing .env file..."
          
          # 1. Start with PRODUCTION_ENV secret
          if [ -n "$PRODUCTION_ENV" ]; then
             printf '%s\n' "$PRODUCTION_ENV" > .env
          else
             touch .env
          fi

          # 2. Append missing variables from the environment
          # Use a helper function to append if missing from .env
          append_if_missing() {
            local var_name="$1"
            local var_value="${!1}" # indirect expansion to get env var value

            if ! grep -q "^$var_name=" .env; then
              if [ -n "$var_value" ]; then
                echo "‚ûï Injecting $var_name from environment/secrets"
                echo "$var_name=$var_value" >> .env
              else
                echo "‚ö†Ô∏è Warning: $var_name is missing from .env and no env var found"
              fi
            fi
          }

          append_if_missing "JWT_SECRET"
          append_if_missing "POSTGRES_PASSWORD"
          append_if_missing "MINIO_ROOT_PASSWORD"
          append_if_missing "PGADMIN_DEFAULT_PASSWORD"
          
          append_if_missing "ACME_EMAIL"
          append_if_missing "POSTGRES_USER"
          append_if_missing "POSTGRES_DB"
          append_if_missing "MINIO_ROOT_USER"
          append_if_missing "PGADMIN_DEFAULT_EMAIL"
          
          append_if_missing "PORT"
          append_if_missing "DEPLOY_DOMAIN"
          append_if_missing "MINIO_ENDPOINT"
          append_if_missing "MINIO_PORT"
          
          # Ensure DATABASE_URL is constructed if missing
          if ! grep -q "^DATABASE_URL=" .env; then
             echo "‚ûï Constructing DATABASE_URL..."
             echo "DATABASE_URL=postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@localhost:5434/$POSTGRES_DB" >> .env
          fi

      - name: Deploy with Docker Compose
          sleep 20

  # ============================================
  # STEP 3: Health Check
  # ============================================
  health-check:
    name: Health Check
    runs-on: self-hosted
    needs: deploy

    steps:
      - name: Check backend health
        run: |
          echo "Checking backend health..."
          for i in {1..30}; do
            if docker exec sabr-backend wget --no-verbose --tries=1 --spider http://localhost:3000/ 2>/dev/null; then
              echo "‚úÖ Backend is healthy!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Backend health check failed"
              docker logs sabr-backend --tail 50
              exit 1
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: Check frontend health
        run: |
          echo "Checking frontend health..."
          for i in {1..15}; do
            if docker exec sabr-frontend wget --no-verbose --tries=1 --spider http://localhost:80/ 2>/dev/null; then
              echo "‚úÖ Frontend is healthy!"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "‚ùå Frontend health check failed"
              docker logs sabr-frontend --tail 50
              exit 1
            fi
            echo "Waiting for frontend... ($i/15)"
            sleep 2
          done

  # ============================================
  # STEP 4: Database Migrations & Seeding
  # ============================================
  migrate-and-seed:
    name: Migrate & Seed
    runs-on: self-hosted
    needs: health-check

    steps:
      - name: Run database migrations
        run: |
          echo "üóÉÔ∏è Running database migrations..."
          docker exec sabr-backend bunx drizzle-kit migrate || echo "Migration may have already been applied"

      - name: Seed admin account
        env:
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          echo "üë§ Seeding admin account..."
          docker exec -e ADMIN_PASSWORD="$ADMIN_PASSWORD" sabr-backend bun run src/scripts/seed-admin.ts || echo "Admin may already exist"

      - name: Seed production data
        env:
          SEED_PASSWORD: ${{ secrets.SEED_PASSWORD }}
        run: |
          echo "üå± Seeding production data (professor, student, labs, projects)..."
          docker exec -e SEED_PASSWORD="$SEED_PASSWORD" sabr-backend bun run src/scripts/seed-production.ts || echo "Production data may already exist"

  # ============================================
  # STEP 5: Cleanup & Summary
  # ============================================
  summary:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [build, deploy, health-check, migrate-and-seed]
    if: success()

    steps:
      - name: Cleanup old images
        run: |
          docker image prune -f

      - name: Deployment Summary
        run: |
          echo "============================================"
          echo "       SABR DEPLOYMENT COMPLETE"
          echo "============================================"
          echo ""
          echo "üåê Public Access:"
          echo "   Frontend: https://sabr.haskify.com"
          echo "   API:      https://api.sabr.haskify.com"
          echo ""
          echo "üì¶ Running Containers:"
          docker ps --filter "name=sabr" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "============================================"

  # ============================================
  # Rollback on Failure
  # ============================================
  rollback:
    name: Rollback on Failure
    runs-on: self-hosted
    needs: [deploy, health-check, migrate-and-seed]
    if: failure()

    steps:
      - name: Show failure logs
        run: |
          echo "‚ùå Deployment failed! Showing logs..."
          echo ""
          echo "=== Backend Logs ==="
          docker logs sabr-backend --tail 30 2>&1 || true
          echo ""
          echo "=== Frontend Logs ==="
          docker logs sabr-frontend --tail 30 2>&1 || true
          echo ""
          echo "=== Traefik Logs ==="
          docker logs traefik --tail 30 2>&1 || true
          echo ""
          echo "‚ö†Ô∏è Manual investigation required."
